<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TEX</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  body{margin:0;font-family:'Inter',sans-serif;background:#121212;color:#fff}
  header{background:#181818;padding:20px 40px;border-bottom:1px solid #2a2a2a;display:flex;justify-content:space-between;align-items:center}
  .logo{font-size:24px;font-weight:700;color:#ff3c3c}
  table{width:90%;margin:40px auto;border-collapse:collapse}
  th,td{text-align:left;padding:14px;border-bottom:1px solid #333}
  th{color:#999;text-transform:uppercase;font-size:14px}
  tr:hover{background:#1e1e1e}
  .btn{background:#ff3c3c;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600}
  .btn:hover{background:#ff1e1e}
  .change-pos{color:#00c46a}
  .change-neg{color:#ff4d4d}
  /* Modal */
  .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center}
  .modal-content{background:#1a1a1a;padding:30px;border-radius:12px;width:360px;text-align:center;position:relative;box-shadow:0 0 20px rgba(0,0,0,.8)}
  .modal-content h2{color:#ff3c3c;margin-bottom:20px}
  .modal-content input{width:80%;padding:10px;border-radius:8px;border:none;margin-bottom:10px;font-size:16px;text-align:center}
  .close{position:absolute;top:15px;right:20px;font-size:28px;color:#fff;cursor:pointer}
  #walletBtn{margin-bottom:10px}
  .status{margin-top:10px;font-size:0.9rem;color:#bbb}
  .toggle-btn{margin-bottom:10px;background:#333;color:#fff;border-radius:6px;padding:6px 12px;cursor:pointer;border:none;font-weight:600}
  .toggle-btn.active{background:#ff3c3c;color:#fff}
</style>
</head>
<body>
<header><div class="logo">TEX</div></header>

<table>
<thead>
<tr>
<th>Token</th>
<th>Price (USD)</th>
<th>24h Change</th>
<th>Market Cap</th>
<th></th>
</tr>
</thead>
<tbody id="token-body">
<tr>
<td>$SPEC</td>
<td id="price">—</td>
<td id="change">—</td>
<td id="mcap">—</td>
<td><button class="btn" onclick="openModal()">Trade</button></td>
</tr>
</tbody>
</table>

<!-- Trade Modal -->
<div id="tradeModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeModal()">&times;</span>
<h2>Trade $SPEC</h2>

<button class="btn" id="walletBtn" onclick="connectWallet()">Connect Wallet</button>

<div>
  <button class="toggle-btn active" id="buyBtn" onclick="setDirection('buy')">Buy SPEC</button>
  <button class="toggle-btn" id="sellBtn" onclick="setDirection('sell')">Sell SPEC</button>
</div>

<input type="number" id="inputAmount" placeholder="Amount" />
<div id="estimate" style="margin-bottom:15px;color:#bbb">≈ —</div>
<button class="btn" onclick="executeSwap()">Swap</button>
<div id="tradeResult" class="status"></div>
</div>
</div>

<script src="https://unpkg.com/@solana/web3.js@1.87.0/lib/index.iife.js"></script>
<script>
const TOKEN = {mint:"28epFLHUSyU9y5tYdXmzT2YK3ozpFkAZvUqC9f9Naray", symbol:"SPEC", totalSupply:1000000000};
const SOL_MINT = "So11111111111111111111111111111111111111112";
let provider=null,walletPubkey=null,direction="buy";

const priceEl=document.getElementById("price");
const changeEl=document.getElementById("change");
const mcapEl=document.getElementById("mcap");

async function fetchSolUsd(){
  try{
    const r=await fetch("https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd");
    const j=await r.json();
    return j.solana.usd;
  }catch(e){return 0;}
}

async function fetchSpecPrice(){
  try{
    const solUsd = await fetchSolUsd();
    // Use larger amount to get valid quote
    const quoteAmount = 10000 * 1e6; // 10,000 SPEC in smallest units
    const quoteR = await fetch(`https://quote-api.jup.ag/v1/quote?inputMint=${TOKEN.mint}&outputMint=${SOL_MINT}&amount=${quoteAmount}`);
    const quoteJ = await quoteR.json();
    if(!quoteJ.data || !quoteJ.data[0]) throw "No quote returned";
    const solOut = quoteJ.data[0].outAmount / 1e9; // SOL
    const priceUSD = (solOut / 10000) * solUsd; // per 1 SPEC
    const marketCap = priceUSD * TOKEN.totalSupply;
    priceEl.textContent = `$${priceUSD.toFixed(6)}`;
    const change24h = 0; // placeholder for new token
    changeEl.textContent = `${change24h.toFixed(2)}%`;
    changeEl.className = change24h>=0?"change-pos":"change-neg";
    mcapEl.textContent = `$${(marketCap/1e6).toFixed(2)}M`;
  }catch(e){console.error(e);priceEl.textContent="N/A";mcapEl.textContent="N/A";changeEl.textContent="-";}
}

fetchSpecPrice();

function openModal(){document.getElementById("tradeModal").style.display="flex";}
function closeModal(){document.getElementById("tradeModal").style.display="none";}

async function connectWallet(){
  if(window.solana && window.solana.isPhantom){
    provider=window.solana;
    try{
      const resp=await provider.connect();
      walletPubkey=resp.publicKey.toString();
      document.getElementById("walletBtn").textContent="Wallet Connected";
      document.getElementById("tradeResult").textContent=`Connected: ${walletPubkey}`;
    }catch(e){console.error(e);}
  }else{alert("Install Phantom wallet!");}
}

function setDirection(dir){
  direction=dir;
  document.getElementById("buyBtn").classList.toggle("active",dir==="buy");
  document.getElementById("sellBtn").classList.toggle("active",dir==="sell");
  updateEstimate();
}

document.getElementById("inputAmount").addEventListener("input", updateEstimate);

async function getQuote(amount){
  const inputMint = direction==="buy"?SOL_MINT:TOKEN.mint;
  const outputMint = direction==="buy"?TOKEN.mint:SOL_MINT;
  const amountUnits = direction==="buy"?amount*1e9:amount*1e6;
  try{
    const r = await fetch(`https://quote-api.jup.ag/v1/quote?inputMint=${inputMint}&outputMint=${outputMint}&amount=${amountUnits}`);
    const j = await r.json();
    return j.data[0];
  }catch(e){console.error(e); return null;}
}

async function updateEstimate(){
  const amt = Number(document.getElementById("inputAmount").value);
  if(!amt){document.getElementById("estimate").textContent="≈ —"; return;}
  const quote = await getQuote(amt);
  if(!quote){document.getElementById("estimate").textContent="≈ —"; return;}
  const outputAmt = quote.outAmount/ (direction==="buy"?1e6:1e9);
  const unit = direction==="buy"?"SPEC":"SOL";
  document.getElementById("estimate").textContent=`≈ ${outputAmt.toFixed(6)} ${unit}`;
}

async function executeSwap(){
  const amt = Number(document.getElementById("inputAmount").value);
  if(!amt || !walletPubkey){alert("Connect wallet and enter amount"); return;}
  document.getElementById("tradeResult").textContent="Executing swap...";

  const quote = await getQuote(amt);
  if(!quote){document.getElementById("tradeResult").textContent="No route found"; return;}

  try{
    const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
    const tx = solanaWeb3.Transaction.from(Buffer.from(quote.swapTransaction, 'base64'));
    const sig = await provider.signAndSendTransaction(tx);
    await connection.confirmTransaction(sig.signature);
    document.getElementById("tradeResult").textContent=`Swap completed! Tx: ${sig.signature}`;
    updateEstimate();
    fetchSpecPrice();
  }catch(e){console.error(e); document.getElementById("tradeResult").textContent="Swap failed";}
}
</script>
</body>
</html>
